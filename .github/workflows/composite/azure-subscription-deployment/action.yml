name: "Azure Subscription Deployment"
description: "Runs New-AzSubscriptionDeployment"

inputs:
  deployment_name:
    required: false
  location:
    required: true
    default: "centralus"
  template_file:
    required: true
  template_parameter_file:
    required: false
  what_if:
    required: true
    default: "true"

outputs:
  deployment:
    description: "The deployment result as JSON"
    value: ${{ steps.deploy.outputs.deployment }}
  what_if_output:
    description: "The what-if output text"
    value: ${{ steps.deploy.outputs.what_if_output }}

runs:
  using: "composite"
  steps:
    - name: App Service Resource Group Deploy
      id: deploy
      uses: azure/powershell@v1
      with:
        inlineScript: |
          $commitSha = "${{ github.sha }}"
          $commitShaShort = $commitSha.substring(0, 7)

          $params = @{
            Location = "${{ inputs.location }}"
            Tag = @{"commit_sha"=$commitShaShort;}
            TemplateFile = "${{ inputs.template_file }}"
            WhatIf = "false" -ne "${{ inputs.what_if }}"
          }

          $templateParameterFile = "${{ inputs.template_parameter_file }}"
          If ($templateParameterFile) { $params['TemplateParameterFile'] = $templateParameterFile }

          $deploymentNameInput = "${{ inputs.deployment_name }}"
          $params['Name'] = If($deploymentNameInput) { $deploymentNameInput } Else { "$($params['Location'])-$($(Get-Date).ToString("yyyyMMddHHss"))" }

          Write-Host "Running New-AzSubscriptionDeployment... $($params | Out-String)"
          
          # Capture what-if output if running in what-if mode
          if ($params['WhatIf']) {
            $whatIfResult = New-AzSubscriptionDeployment @params 2>&1 | Out-String
            
            # Write to GitHub output
            $whatIfEscaped = $whatIfResult -replace '%', '%25' -replace "`n", '%0A' -replace "`r", '%0D'
            echo "what_if_output<<EOF" >> $env:GITHUB_OUTPUT
            echo "$whatIfResult" >> $env:GITHUB_OUTPUT
            echo "EOF" >> $env:GITHUB_OUTPUT
            
            Write-Host $whatIfResult
          } else {
            $result = $(New-AzSubscriptionDeployment @params | ConvertTo-Json)
            echo "deployment=$result" >> $env:GITHUB_OUTPUT
          }
        azPSVersion: "latest"
        failOnStandardError: "false"
