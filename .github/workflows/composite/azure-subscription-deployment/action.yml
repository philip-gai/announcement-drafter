name: "Azure Subscription Deployment"
description: "Runs New-AzSubscriptionDeployment"

inputs:
  deployment_name:
    required: false
  location:
    required: true
    default: "centralus"
  template_file:
    required: true
  template_parameter_file:
    required: false
  what_if:
    required: true
    default: "true"
  what_if_output_file:
    description: "Path to write what-if output for external consumption"
    required: false
    default: ""

outputs:
  deployment:
    description: "The deployment result as JSON"
    value: ${{ steps.deploy.outputs.deployment }}

runs:
  using: "composite"
  steps:
    - name: App Service Resource Group Deploy
      id: deploy
      uses: azure/powershell@v1
      with:
        inlineScript: |
          $commitSha = "${{ github.sha }}"
          $commitShaShort = $commitSha.substring(0, 7)

          $params = @{
            Location = "${{ inputs.location }}"
            Tag = @{"commit_sha"=$commitShaShort;}
            TemplateFile = "${{ inputs.template_file }}"
            WhatIf = "false" -ne "${{ inputs.what_if }}"
          }

          $templateParameterFile = "${{ inputs.template_parameter_file }}"
          If ($templateParameterFile) { $params['TemplateParameterFile'] = $templateParameterFile }

          $deploymentNameInput = "${{ inputs.deployment_name }}"
          $params['Name'] = If($deploymentNameInput) { $deploymentNameInput } Else { "$($params['Location'])-$($(Get-Date).ToString("yyyyMMddHHss"))" }

          Write-Host "Running New-AzSubscriptionDeployment... $($params | Out-String)"

          # Capture what-if output if running in what-if mode
          if ($params['WhatIf']) {
            # Use Get-AzSubscriptionDeploymentWhatIfResult for better output capture
            $whatIfParams = @{
              Location = $params['Location']
              TemplateFile = $params['TemplateFile']
            }
            if ($params['TemplateParameterFile']) {
              $whatIfParams['TemplateParameterFile'] = $params['TemplateParameterFile']
            }
            
            Write-Host "Running What-If deployment analysis..."
            $whatIfResult = Get-AzSubscriptionDeploymentWhatIfResult @whatIfParams
            
            # Format the what-if result with proper structure
            $outputLines = @()
            $outputLines += "**Status:** $($whatIfResult.Status)"
            $outputLines += ""
            
            if ($whatIfResult.Error) {
              $outputLines += "**Error:** $($whatIfResult.Error)"
              $outputLines += ""
            }
            
            if ($whatIfResult.Changes -and $whatIfResult.Changes.Count -gt 0) {
              $outputLines += "### Resource Changes"
              $outputLines += ""
              $outputLines += "| Change | Resource |"
              $outputLines += "|--------|----------|"
              
              foreach ($change in $whatIfResult.Changes) {
                $changeType = $change.ChangeType
                $icon = switch ($changeType) {
                  "Create" { "üÜï Create" }
                  "Delete" { "üóëÔ∏è Delete" }
                  "Modify" { "‚úèÔ∏è Modify" }
                  "Deploy" { "üöÄ Deploy" }
                  "NoChange" { "‚ö™ No Change" }
                  "Ignore" { "‚è≠Ô∏è Ignore" }
                  default { "‚ùì $changeType" }
                }
                $resourceId = $change.RelativeResourceId
                if (-not $resourceId) { $resourceId = $change.ResourceId }
                $outputLines += "| $icon | ``$resourceId`` |"
              }
            } else {
              $outputLines += "‚úÖ **No changes detected.** Infrastructure is up to date."
            }
            
            $formattedOutput = $outputLines -join "`n"
            
            # Write to file if output file path is specified
            $outputFile = "${{ inputs.what_if_output_file }}"
            if ($outputFile) {
              $formattedOutput | Out-File -FilePath $outputFile -Encoding utf8 -NoNewline
              Write-Host "What-if output written to: $outputFile"
            }
            
            Write-Host $formattedOutput
          } else {
            $result = $(New-AzSubscriptionDeployment @params | ConvertTo-Json -Compress -Depth 10)
            # Use delimiter syntax for multi-line output - use Add-Content for consistent line endings
            $delimiter = "EOF_$(Get-Random)"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "deployment<<$delimiter"
            Add-Content -Path $env:GITHUB_OUTPUT -Value $result
            Add-Content -Path $env:GITHUB_OUTPUT -Value $delimiter
          }
        azPSVersion: "latest"
        failOnStandardError: "false"
