name: "App Service CI / CD"

on:
  pull_request: {}
  push:
    branches: [main]
    paths: [infrastructure/**.bicep, infrastructure/**.parameters.json]
  workflow_dispatch:
    inputs:
      What-If:
        description: "What-If: Set to 'false' if you want to deploy"
        required: true
        default: "true"

env:
  github_app_client_secret: ${{ secrets.GITHUBAPP_CLIENT_SECRET }}
  github_app_private_ssh_key_secret: ${{ secrets.PRIVATE_SSH_KEY }}
  github_app_webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
  location: "centralus"
  azure_client_id: "a815ac51-ea5e-4b31-aa3c-eefb9c87403b"
  azure_subscription_id: "7100b295-05bb-4ecf-a59b-246bd1f17d9a"
  azure_tenant_id: "87e276c0-7d18-4d86-948a-ba5eea990211"
  template_file: "infrastructure/announcement-drafter.bicep"
  template_parameter_file: "infrastructure/announcement-drafter.parameters.json"

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout
  pull-requests: write # Required for PR comments

jobs:
  what-if-deploy:
    name: What-If Deploy
    if: github.event_name == 'pull_request' || ( github.event_name == 'workflow_dispatch' && github.event.inputs.What-If == 'true' )
    runs-on: ubuntu-latest
    environment:
      name: "production"
    env:
      what_if: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: az bicep build --file "${{ env.template_file }}"
        shell: bash
        run: az bicep build --file "${{ env.template_file }}"
      - name: Replace Tokens
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["infrastructure/**/*.parameters.json"]'
        env:
          GITHUB_CLIENT_SECRET: ${{ env.github_app_client_secret }}
          PRIVATE_SSH_KEY: ${{ env.github_app_private_ssh_key_secret }}
          WEBHOOK_SECRET: ${{ env.github_app_webhook_secret }}
      - name: Azure Login
        uses: ./.github/workflows/composite/azure-login
        with:
          client_id: ${{ env.azure_client_id }}
          subscription_id: ${{ env.azure_subscription_id }}
          tenant_id: ${{ env.azure_tenant_id }}
      - name: What-If Deploy
        id: whatif
        uses: ./.github/workflows/composite/azure-subscription-deployment
        with:
          template_file: ${{ env.template_file }}
          template_parameter_file: ${{ env.template_parameter_file }}
          what_if: ${{ env.what_if }}
          what_if_output_file: ${{ runner.temp }}/whatif-output.txt
      - name: Create Comment Body
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          cat > "${{ runner.temp }}/comment-body.md" << ENDOFCOMMENT
          ## ðŸ” Infrastructure What-If Deployment Results

          ENDOFCOMMENT

          if [ -f "${{ runner.temp }}/whatif-output.txt" ]; then
            cat "${{ runner.temp }}/whatif-output.txt" >> "${{ runner.temp }}/comment-body.md"
          else
            echo "âš ï¸ No what-if output available" >> "${{ runner.temp }}/comment-body.md"
          fi

          cat >> "${{ runner.temp }}/comment-body.md" << ENDOFCOMMENT

          ---
          ðŸ“‹ [View full workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ENDOFCOMMENT
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: whatif-infrastructure
          path: ${{ runner.temp }}/comment-body.md
  deploy:
    name: Deploy
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || ( github.event_name == 'workflow_dispatch' && github.event.inputs.What-If == 'false' ))
    concurrency: production-deploy-infra
    runs-on: ubuntu-latest
    environment:
      name: "production"
    env:
      what_if: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Replace Tokens
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["infrastructure/**/*.parameters.json"]'
        env:
          GITHUB_CLIENT_SECRET: ${{ env.github_app_client_secret }}
          PRIVATE_SSH_KEY: ${{ env.github_app_private_ssh_key_secret }}
          WEBHOOK_SECRET: ${{ env.github_app_webhook_secret }}
      - name: Azure Login
        uses: ./.github/workflows/composite/azure-login
        with:
          client_id: ${{ env.azure_client_id }}
          subscription_id: ${{ env.azure_subscription_id }}
          tenant_id: ${{ env.azure_tenant_id }}
      - name: Deploy
        uses: ./.github/workflows/composite/azure-subscription-deployment
        with:
          template_file: ${{ env.template_file }}
          template_parameter_file: ${{ env.template_parameter_file }}
          what_if: ${{ env.what_if }}
